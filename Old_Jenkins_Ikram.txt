pipeline {
    agent {label "Agent1"}

    stages {
        stage('Code') {
            steps {
                 echo 'Code Cloning From Git'
                git url:"https://github.com/IkramAnsari01/DjangoReactApp",branch: "main"
                echo 'Code Cloning Successful'
            }
        }
        
        stage('Build') {
            steps {
                echo 'Building the code'
                echo 'Creating Image'
                sh "docker build -t notes-app:latest ."
                echo 'Image Built'
            }
        }
        stage('DockerHub Push'){
            steps{
                echo ' Pushing build Image to Docker Hub'
                withCredentials([usernamePassword(
                        'credentialsId':"DockerHubCred",
                        passwordVariable: "DocPass",
                        usernameVariable: "DocUser")]){
                            sh "docker login -u ${env.DocUser} -p ${env.DocPass}" 
                            sh " docker image tag notes-app:latest ${env.DocUser}/notes-app:latest"
                            sh "docker push ${env.DocUser}/notes-app:latest"
                        }
            }
        }
        
        stage('Test') {
            steps {
                echo 'Testing the code'
            }
        }
        
        stage('Deploy') {
            steps {
                echo 'Deploying the code'
                sh '''
                    # 1. Stop AND Remove the old container
                    echo "Stopping old container..."
                    docker stop notes-app || true
                    
                    echo "Removing old container..."
                    docker rm notes-app || true   # <--- THIS WAS MISSING
                    
                    # 2. Force kill port 8000 (Safety measure)
                    echo "Freeing port 8000..."
                    fuser -k 8000/tcp || true
                    
                    # 3. Build the new image
                    echo "Building new image..."
                    docker build --no-cache -t notes-app:latest .
                    
                    # 4. Run the new container
                    echo "Starting new container..."
                    docker run -d --name notes-app -p 8000:8000 notes-app:latest
                    
                    # 5. Cleanup and Verification
                    echo "Removing dangling images..."
                    docker image prune -f
                    
                    echo "Verifying deployment..."
                    sleep 5
                    docker ps | grep notes-app
                '''
            }
        }
    }
}
